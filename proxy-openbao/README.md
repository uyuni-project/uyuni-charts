<!--
SPDX-FileCopyrightText: 2026 SUSE LLC
SPDX-FileContributor: CÃ©dric Bosdonnat

SPDX-License-Identifier: MIT
-->

# Requirements

Before installing this helm chart, ensure that [cert-manager](https://cert-manager.io/docs/installation/helm/) and
[trust-manager](https://cert-manager.io/docs/trust/trust-manager/installation/#3-install-trust-manager) are installed in the cluster.
If they are not installed in the `cert-manager` namespace, set the `certManagerNamespace` value.

[OpenBao](https://openbao.org) or Hashicorp [Vault](https://developer.hashicorp.com/vault) needs to be installed and configured for PKI secrets.
It also needs to allow cert-manager to authenticate.
See the cert-manager [Vault issuer documentation](https://cert-manager.io/docs/configuration/vault/) for details.

Also read the requirements in the main [README](../) as they apply here too.

The following values need to be set:

```
openbao:
  address: https://$OPENBAO_FQDN

proxy-helm:
  # All the values for proxy-helm should follow
```

The root CA certificate is expected to be stored in a secret in the cert-manager namespace.
By default, the `ca.crt` key in the `root-ca` secret will be looked for, but another name can be set using the `rootCASecret` value fields.
The root CA is expected to be used for both OpenBao's server certificate and Uyuni's.

The proxy configuration file generated by the server need to be unpacked and its files passed as global values using the `--set-file` helm parameter:

```bash
     --set-file global.config=path/to/config.yaml \
     --set-file global.ssh=path/to/ssh.yaml \
     --set-file global.httpd=path/to/httpd.yaml
```


# OpenBao setup

## OpenBao installation

The rest of this documentation assumes OpenBao is already running and setup for the Uyuni server.
Only what is needed for the proxy will be shown here.
Check [the server-openbao README](../server-openbao/) for an installation documentation.

## OpenBao Configuration

In the following commands, `$BAO` needs to be changed to `kubectl --context $BAO_CTX exec -ti -n openbao-system openbao-0 -- bao` if OpenBao has been installed in a Kubernetes cluster.
Mind to set the `BAO_CTX` to the `kubectl` configuration context to use to reach the OpenBao in its cluster as it is likely not to be in the proxy's cluster.
This assumes, that the bao client is already logged in.

The OpenBao connection for a proxy cluster is slightly different than the one on the server since OpenBao is living in a separate cluster.

### Configure Kubernetes Auth

**Note:** this example implements the Kubernetes authentication, but there are other possible with openbao and cert-manager.
See the possible ones in the [issuer documentation](https://cert-manager.io/docs/configuration/vault/#authenticating).
If another authentication is needed, modify the `uyuni-openbao-issuer` definition in the `templates/certificates.yaml` file.

Each Kubernetes cluster needs it own authentication path in OpenBao.
In the following commands change `CLUSTER_PATH` to be unique on the OpenBao server.
If multiple proxies need to be set up in separate clusters, this value needs to be different for each.

**Important:** the `CLUSTER_PATH` value needs to be set in the `openbao.auth.mountPath` value.

Set the `PROXY_CTX` variable to the `kubectl` context of the proxy.

TODO Add the openbao cluster CA

```bash
CLUSTER_PATH=kubernetes/uyuni-proxy-cluster
$BAO auth enable -path $CLUSTER_PATH kubernetes
CLUSTER_URL=`kubectl --context $PROXY_CTX cluster-info | grep Kubernetes | sed 's/^.*\(http.*\)$/\1/'`
$BAO write auth/$CLUSTER_PATH/config kubernetes_host="$CLUSTER_URL"
```

### Bind the role for the proxy cluster:

Replace the `ISSUER_ROLE` with the value used for the server configuration if different from the default.
Also remember to reflect it in the `openbao.auth.roleName` value.

`CERT_MANAGER_NAMESPACE` needs to be set to the namespace where cert-manager is installed.

```bash
ISSUER_ROLE=uyuni-issuer-role
CERT_MANAGER_NAMESPACE=cert-manager
$BAO write auth/$CLUSTER_PATH/role/$ISSUER_ROLE \
    bound_service_account_names=openbao-issuer-sa \
    bound_service_account_namespaces=$CERT_MANAGER_NAMESPACE \
    token_policies=uyuni-pki-policy \
    audience="vault://uyuni-openbao-issuer"
```

## cert-manager RBAC

Cert-manager will have to request tokens for the service account to be able to authenticate to OpenBao.
This helm chart will add the necessary service account and add the cluster role and role binding for this: permissions will be needed for this.

# Installing

If not already done, create the root-ca secret with the root CA:

```bash
kubectl --context $PROXY_CTX create secret generic openbao-root-ca --from-file=ca.crt=my-openbao-conf/root-ca.crt -n cert-manager
```

Install the helm chart by passing the proxy configuration files generated by the server with the `--set-file` parameters.
For instance like this command:

```bash
tar xf proxy-config.tar.gz
helm install uyuni . --create-namespace -n uyuni-proxy -f ../my-proxy-openbao.yaml \
                     --set-file global.config=config.yaml \
                     --set-file global.ssh=ssh.yaml \
                     --set-file global.httpd=httpd.yaml
```

Once the chart is installed, the `uyuni-openbao-issuer` will fail to connect to OpenBao.
This is because OpenBao doesn't have a JWT token from the proxy cluster.
The helm chart install a secret to create a long-lived token for the reviewer, but it needs to be set in the OpenBao authentication configuration for the proxy cluster.
Run the following commands to update it.

```bash
TOKEN_REVIEWER_JWT=$(kubectl --context $PROXY_CTX get secret openbao-reviewer-token -n cert-manager -o jsonpath='{.data.token}' | base64 -d)
kubectl --context $PROXY_CTX config view --raw --minify --flatten -o jsonpath='{.clusters[0].cluster.certificate-authority-data}' | base64 -d | \
         $BAO write auth/$CLUSTER_PATH/config kubernetes_host="$CLUSTER_URL" kubernetes_ca_cert=- token_reviewer_jwt="$TOKEN_REVIEWER_JWT"
```


# Troubleshooting

Check the issuer status: `kubectl --context $PROXY_CTX describe clusterissuer uyuni-openbao-issuer`
If the issuer gets a permission denied, run the `openbao-auth-check.sh` script to verify the authentication chain.

To trigger a refresh of the cluster issuer on the controller, run this command:

```bash
kubectl patch clusterissuer uyuni-openbao-issuer \
           --type='merge' \
           -p '{"metadata":{"annotations":{"refresh":"'$(date +%s)'"}}}'
```


# Uninstalling

**Uninstalling OpenBao doesn't remove the persistent volume and its claim, they need to be manually deleted.**

By default, `cert-manager` does not remove the created secrets.
In such a case, delete them after uninstalling the helm chart:

```
kubectl delete secrets -n cert-manager uyuni-ca
kubectl delete secrets -n <uyuni-namspace> db-cert uyuni-cert
```
